<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>SSO-Discord</title>
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta name="referrer" content="no-referrer" />
	<link rel="stylesheet" href="https://n138-kz.github.io/lib/master.css?t=0">
	<style>
		/* Basic theme */
		body {
			margin: 0 auto;
			width: 90%;
			padding-bottom: 100px;
		}
	</style>
	<script src="https://n138-kz.github.io/lib/master.js"></script>
	<script>
		init_setTopMaker();
		init_setFavicon();
		init_setHeaderText();
	</script>
	<script>
		function get_GETarray(q) {
			/*
			* @args q: (decodeURI(location.search)+'&').replace(/^\?/,'')
			*/
			q=q.split('&')
			let queries=[];
			for (let i=0; i<q.length; i++) {
				if(q[i].length>0){
					if(q[i].indexOf('=')>0){
						query=q[i].split('=');
						queries[query[0]]=query[1];
					} else {
						queries[q[i]]=null;
					}
				}
			}
			return queries;
		}
	</script>
	<script>
		window.addEventListener('DOMContentLoaded', ()=>{
			const d_id_signin=[...document.querySelectorAll('.d_id_signin')];
			d_id_signin_attr={
				login_uri:document.querySelector('#d_id_onload').dataset.login_uri,
				client_id:document.querySelector('#d_id_onload').dataset.client_id,
			}
			d_id_signin_elm=document.createElement('p');
			d_id_signin_elm.style.height='64px';
			d_id_signin_elm.style.paddingLeft='100px';
			d_id_signin_elm.style.cursor='pointer';
			d_id_signin_elm.style.backgroundColor='var(--color-discord-color-fg)';
			d_id_signin_elm.setAttribute('onclick', 'location.href="https://discord.com/oauth2/authorize?client_id='+d_id_signin_attr.client_id+'&response_type=code&redirect_uri='+d_id_signin_attr.login_uri+'&scope=identify+email"');
			d_id_signin.map((e)=>{
				console.debug(e);
				d_id_signin_elm.innerText=e.dataset.text;
				e.style.height='64px';
				e.style.backgroundImage='url(discord-icon.png)';
				e.style.backgroundRepeat='no-repeat';
				e.appendChild(d_id_signin_elm);
			});
		});
		window.addEventListener('DOMContentLoaded', ()=>{
			console.log(get_GETarray((decodeURI(location.search)+'&').replace(/^\?/,'')));
			let query=get_GETarray((decodeURI(location.search)+'&').replace(/^\?/,''));
			if(query.code !== undefined){
				document.querySelector('#result01').value=query.code;
				document.querySelector('#d_id_onload').dataset.callback;
			}
		});
	</script>
</head>
<body>
	<div class="d_id_signin" data-theme="dark" data-text="signin_with_discord" data-size="large" data-logo_alignment="left"></div>
	<div id="d_id_onload" data-callback="onlogin"></div>
	<div>
		token: <input readonly type="text" id="result01" class="set-mosaic" onclick="this.select();navigator.clipboard.writeText(this.value).then((e)=>{console.debug('clipboard successfully set',e);}, (e)=>{console.error('Failed the copy text.',e);});" style="max-width: 500px;width: 95%;">
	</div>
	<script>
		document.querySelector('#d_id_onload').dataset.login_uri = location.origin + location.pathname;
		document.querySelector('#d_id_onload').dataset.client_id = '1331215597119340585';
	</script>
	<script>
		async function onlogin(discodeUser) {
			discodeUser['recv_time']=Math.trunc(new Date().getTime()/10**3);
			console.log(discodeUser);
			document.querySelector('#result01').value=discodeUser.credential;
			localStorage.setItem( '_' + '.'+'googleauthn', JSON.stringify(discodeUser) );
			localStorage.setItem( '_' + '.'+'authn', JSON.stringify(discodeUser) );
			localStorage.setItem( (btoa(location.href)).slice(0, 16) + '.'+'googleauthn', JSON.stringify(discodeUser) );
			sessionStorage.setItem( (btoa(location.href)).slice(0, 16) + '.'+'googleauthn', JSON.stringify(discodeUser) );

			const url_apiserver = 'https://api.n138.jp/sso_discord/server/';
			const myHeaders = new Headers();
			myHeaders.append('X-TOKEN', discodeUser.credential);
			try {
				const response = await fetch(url_apiserver, {
					headers: myHeaders,
					mode: 'cors',
				});
				if (!response.ok) {
					throw new Error(`レスポンスステータス: ${response.status}`);
				}
				const json = await response.json();
				console.log(json);
			} catch (error) {
				console.error(error.message);
				console.trace(error);
			}
		}
	</script>
</body>